<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Time Traffic Weather Visualization</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            width: 100%;
            background-color: #6200ea;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            display: flex;
            width: 100%;
            height: calc(100vh - 80px);
        }

        .instance {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        .instance h2 {
            margin-top: 0;
            color: #6200ea;
        }

        .instance label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .instance select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            background-color: #f9f9f9;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .instance select:hover {
            border-color: #6200ea;
        }

        .chart-container {
            width: 100%;
            flex: 1;
            min-height: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .data-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
        }

        .data-section {
            flex: 1;
            margin: 0 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .data-section h3 {
            margin-top: 0;
            color: #6200ea;
        }

        .data-section pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow-x: auto;
        }

        .arrival-status {
            padding: 8px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .car-marker {
            background: transparent;
            border: none;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Real Time Route Analysis and Visualization</h1>
    </div>

    <div class="container">
        <div class="instance" id="instance-1">
            <h2>Instance 1</h2>
            <label for="file-select-1">Select File:</label>
            <select id="file-select-1">
                <option value="">Select a file...</option>
            </select>

            <h2>Current Data</h2>
            <div class="data-container">
                <div class="data-section" id="weatherData-1">
                    <h3>Weather Data</h3>
                    <pre id="weatherOutput-1">Waiting for weather data...</pre>
                </div>
                <div class="data-section" id="trafficData-1">
                    <h3>Traffic Data</h3>
                    <pre id="trafficOutput-1">Waiting for traffic data...</pre>
                </div>
                <div class="data-section" id="carData-1">
                    <h3>Car Data</h3>
                    <pre id="carOutput-1">Waiting for car data...</pre>
                </div>
            </div>

            <h3>Car Speed vs Speed Limit</h3>
            <div class="chart-container">
                <canvas id="chart-speed-limit-1"></canvas>
            </div>
            
            <h3>TomTom Live Speed vs Calculated Speed</h3>
            <div class="chart-container">
                <canvas id="chart-traffic-speed-1"></canvas>
            </div>

            <h2>Initial Route</h2>
            <div class="arrival-status" id="arrivalStatus-1">Status: In Transit</div>
            <div id="map-1" class="chart-container"></div>
        </div>

        <div class="instance" id="instance-2">
            <h2>Instance 2</h2>
            <label for="file-select-2">Select File:</label>
            <select id="file-select-2">
                <option value="">Select a file...</option>
            </select>

            <h2>Current Data</h2>
            <div class="data-container">
                <div class="data-section" id="weatherData-2">
                    <h3>Weather Data</h3>
                    <pre id="weatherOutput-2">Waiting for weather data...</pre>
                </div>
                <div class="data-section" id="trafficData-2">
                    <h3>Traffic Data</h3>
                    <pre id="trafficOutput-2">Waiting for traffic data...</pre>
                </div>
                <div class="data-section" id="carData-2">
                    <h3>Car Data</h3>
                    <pre id="carOutput-2">Waiting for car data...</pre>
                </div>
            </div>

            <h3>Car Speed vs Speed Limit</h3>
            <div class="chart-container">
                <canvas id="chart-speed-limit-2"></canvas>
            </div>
            
            <h3>TomTom Live Speed vs Calculated Speed</h3>
            <div class="chart-container">
                <canvas id="chart-traffic-speed-2"></canvas>
            </div>

            <h2>Initial Route</h2>
            <div class="arrival-status" id="arrivalStatus-2">Status: In Transit</div>
            <div id="map-2" class="chart-container"></div>
        </div>
    </div>

    <script>
        // Initialize maps for both instances
        const map1 = L.map('map-1').setView([48.136995, 11.576924], 13);
        const map2 = L.map('map-2').setView([48.136995, 11.576924], 13);

        // Add OpenStreetMap tiles to both maps
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map1);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map2);

        // Store car markers and routes
        const carMarkers = {};
        const carRoutes = {};

        // Function to update car position on map
        function updateCarPosition(instanceId, lat, lng) {
            const map = instanceId === 1 ? map1 : map2;
            
            // Remove previous marker if exists
            if (carMarkers[instanceId]) {
                map.removeLayer(carMarkers[instanceId]);
            }

            // Create custom car icon
            const carIcon = L.icon({
                iconUrl: 'https://lehre.bpm.in.tum.de/~ge27lol/Route-Analysis-Project/car-icon.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            // Add new marker
            carMarkers[instanceId] = L.marker([lat, lng], {
                icon: carIcon,
                zIndexOffset: 1000
            }).addTo(map);

            // Add to route if it exists
            if (carRoutes[instanceId]) {
                carRoutes[instanceId].addLatLng([lat, lng]);
            } else {
                carRoutes[instanceId] = L.polyline([[lat, lng]], {color: 'red'}).addTo(map);
            }

            // Center map on new position
            map.setView([lat, lng], 13);
        }

        // Function to populate dropdown menus
        async function loadFiles(dropdownId) {
            const baseUrl = 'https://lehre.bpm.in.tum.de/~ge27lol/Route-Analysis-Project/data/';
            const response = await fetch(baseUrl);
            const text = await response.text();
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(text, 'text/html');
            const links = htmlDoc.querySelectorAll('a');

            const dropdown = document.getElementById(dropdownId);
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('?')) {
                    const option = document.createElement('option');
                    option.value = baseUrl + href;
                    option.textContent = href;
                    dropdown.appendChild(option);
                }
            });
        }

        // Function to extract the unique code from the filename
        function extractUniqueCode(filename) {
            const match = filename.match(/\d+/g);
            return match ? match[match.length - 1] : null;
        }

        // Function to load initial route data and draw the route on the map
        async function loadInitialRouteAndDrawMap(map, uniqueCode, instanceId) {
            const initialRouteUrl = `https://lehre.bpm.in.tum.de/~ge27lol/Route-Analysis-Project/data/initial_route_${uniqueCode}.json`;
            try {
                const response = await fetch(initialRouteUrl);
                const jsonData = await response.json();

                // Clear existing route if any
                if (carRoutes[instanceId]) {
                    map.removeLayer(carRoutes[instanceId]);
                    delete carRoutes[instanceId];
                }

                // Extract coordinates from the JSON data
                const coordinates = jsonData.coordinates.map(coord => [coord[1], coord[0]]);

                // Draw the route on the map
                L.polyline(coordinates, { color: '#6200ea' }).addTo(map);

                // Fit the map to the bounds of the route
                map.fitBounds(L.latLngBounds(coordinates));

                // Initialize empty route for car tracking
                carRoutes[instanceId] = L.polyline([], {color: 'red'}).addTo(map);
            } catch (error) {
                console.error('Error loading initial route data:', error);
            }
        }

        // Chart management
        const charts = {
            'speedLimit': {
                'chart-1': null,
                'chart-2': null
            },
            'trafficSpeed': {
                'chart-1': null,
                'chart-2': null
            }
        };

        // Function to create a chart
        function createChart(chartType, canvasId, initialData = null) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts[chartType][canvasId]) {
                charts[chartType][canvasId].destroy();
            }

            const config = {
                type: 'line',
                data: {
                    labels: initialData?.timestamps || [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Time' },
                            ticks: { autoSkip: true, maxTicksLimit: 20 }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Speed (km/h)' }
                        }
                    }
                }
            };

            if (chartType === 'speedLimit') {
                config.data.datasets = [
                    {
                        label: 'Current Speed',
                        data: initialData?.current_speed || [],
                        borderColor: '#6200ea',
                        fill: false,
                    },
                    {
                        label: 'Speed Limit',
                        data: initialData?.current_speed_limit?.map(speed => speed === -1 ? null : speed) || [],
                        borderColor: '#ff6384',
                        borderDash: [5, 5],
                        fill: false,
                    }
                ];
            } else { // trafficSpeed
                config.data.datasets = [
                    {
                        label: 'Car Speed',
                        data: initialData?.current_speed || [],
                        borderColor: '#6200ea',
                        fill: false,
                    },
                    {
                        label: 'Traffic Speed',
                        data: initialData?.traffic_speed || [],
                        borderColor: '#00bcd4',
                        fill: false,
                    }
                ];
            }

            charts[chartType][canvasId] = new Chart(ctx, config);
            return charts[chartType][canvasId];
        }

        // Function to update chart data
        function updateChart(chartType, chartId, newData) {
            if (charts[chartType][chartId]) {
                const chart = charts[chartType][chartId];
                
                chart.data.labels.push(newData.timestamp);
                
                if (chartType === 'speedLimit') {
                    chart.data.datasets[0].data.push(newData.current_speed);
                    const updatedSpeedLimit = newData.current_speed_limit === -1 ? null : newData.current_speed_limit;
                    chart.data.datasets[1].data.push(updatedSpeedLimit);
                } else { // trafficSpeed
                    chart.data.datasets[0].data.push(newData.current_speed);
                    chart.data.datasets[1].data.push(newData.traffic_speed);
                }
                
                chart.update();
            }
        }

        // Function to update the SSE connection with the instance_id
        function updateSSEConnection(instanceId, uniqueCode) {
            // Close the existing EventSource connection (if any)
            if (window[`eventSource${instanceId}`]) {
                window[`eventSource${instanceId}`].close();
            }

            // Create a new EventSource with the instance_id as a query parameter
            const sseUrl = `https://lehre.bpm.in.tum.de/ports/12879/sse?instance_id=${uniqueCode}`;
            window[`eventSource${instanceId}`] = new EventSource(sseUrl);

            // Store last traffic data for comparison chart
            const lastTrafficData = { speed: null, timestamp: null };

            window[`eventSource${instanceId}`].onmessage = function(event) {
                const data = JSON.parse(event.data);
                const timestamp = new Date().toLocaleTimeString();

                // Update weather data
                const weatherOutput = document.getElementById(`weatherOutput-${instanceId}`);
                if (data["weather"]) {
                    weatherOutput.textContent = JSON.stringify(data["weather"], null, 2);
                }

                // Update traffic data
                const trafficOutput = document.getElementById(`trafficOutput-${instanceId}`);
                if (data["traffic"]) {
                    trafficOutput.textContent = JSON.stringify(data["traffic"], null, 2);
                    
                    // Extract traffic speed (use first live speed if available, or direct speed value)
                    const trafficSpeed = data["traffic"].live_speeds?.[0] || data["traffic"].speed;
                    if (trafficSpeed !== undefined) {
                        lastTrafficData.speed = trafficSpeed;
                        lastTrafficData.timestamp = timestamp;
                    }
                }

                // Update car data and position
                const carOutput = document.getElementById(`carOutput-${instanceId}`);
                if (data["car"]) {
                    carOutput.textContent = JSON.stringify(data["car"], null, 2);
                    
                    // Update arrival status
                    const arrivalStatus = document.getElementById(`arrivalStatus-${instanceId}`);
                    if (data["car"].arrived) {
                        arrivalStatus.textContent = "Status: ARRIVED";
                        arrivalStatus.style.color = "green";
                        arrivalStatus.style.fontWeight = "bold";
                    } else {
                        arrivalStatus.textContent = "Status: In Transit";
                        arrivalStatus.style.color = "";
                        arrivalStatus.style.fontWeight = "";
                    }

                    // Update car position on map
                    if (data["car"].current_latitude && data["car"].current_longitude) {
                        updateCarPosition(
                            instanceId, 
                            data["car"].current_latitude, 
                            data["car"].current_longitude
                        );
                    }

                    // Update charts if car hasn't arrived
                    if (!data["car"].arrived) {
                        // Update speed limit chart
                        updateChart('speedLimit', `chart-speed-limit-${instanceId}`, {
                            timestamp: timestamp,
                            current_speed: data["car"].current_speed,
                            current_speed_limit: data["car"].current_speed_limit
                        });

                        // Update traffic comparison chart if we have traffic data
                        if (lastTrafficData.speed !== null) {
                            updateChart('trafficSpeed', `chart-traffic-speed-${instanceId}`, {
                                timestamp: timestamp,
                                current_speed: data["car"].current_speed,
                                traffic_speed: data["traffic"].live_speeds
                            });
                        }
                    }
                }
            };

            // Handle errors
            window[`eventSource${instanceId}`].onerror = function(error) {
                console.error(`Error occurred for instance ${instanceId}:`, error);
                const weatherOutput = document.getElementById(`weatherOutput-${instanceId}`);
                const trafficOutput = document.getElementById(`trafficOutput-${instanceId}`);
                const carOutput = document.getElementById(`carOutput-${instanceId}`);

                weatherOutput.textContent = 'Error occurred while fetching weather data.';
                trafficOutput.textContent = 'Error occurred while fetching traffic data.';
                carOutput.textContent = 'Error occurred while fetching car data.';
            };
        }

        // Function to load JSON data and update the charts and map
        async function loadDataAndUpdateChart(dropdownId, instanceId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.addEventListener('change', async function() {
                const fileUrl = this.value;
                if (!fileUrl) return;

                try {
                    const response = await fetch(fileUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const jsonData = await response.json();

                    // Extract data for charts
                    const timestamps = jsonData.car.map(entry => entry.timestamp);
                    const currentSpeed = jsonData.car.map(entry => entry.current_speed);
                    const currentSpeedLimit = jsonData.car.map(entry => entry.current_speed_limit);

                    // Initialize charts
                    createChart('speedLimit', `chart-speed-limit-${instanceId}`, {
                        timestamps: timestamps,
                        current_speed: currentSpeed,
                        current_speed_limit: currentSpeedLimit
                    });

                    createChart('trafficSpeed', `chart-traffic-speed-${instanceId}`, {
                        timestamps: timestamps,
                        current_speed: currentSpeed,
                        traffic_speed: currentSpeed // Will be updated with real traffic data via SSE
                    });

                    // Extract unique code (instance_id) from the filename
                    const uniqueCode = extractUniqueCode(fileUrl);
                    if (uniqueCode) {
                        // Load and draw the initial route
                        await loadInitialRouteAndDrawMap(
                            instanceId === 1 ? map1 : map2, 
                            uniqueCode, 
                            instanceId
                        );

                        // Update the SSE URL with the instance_id
                        updateSSEConnection(instanceId, uniqueCode);
                    }
                } catch (error) {
                    console.error('Error loading JSON data:', error);
                }
            });
        }

        // Initialize everything when page loads
        window.onload = function() {
            loadFiles('file-select-1');
            loadFiles('file-select-2');

            // Initialize empty charts
            createChart('speedLimit', 'chart-speed-limit-1');
            createChart('trafficSpeed', 'chart-traffic-speed-1');
            createChart('speedLimit', 'chart-speed-limit-2');
            createChart('trafficSpeed', 'chart-traffic-speed-2');

            // Set up event listeners
            loadDataAndUpdateChart('file-select-1', 1);
            loadDataAndUpdateChart('file-select-2', 2);
        };
    </script>
</body>
</html>